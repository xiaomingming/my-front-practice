<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>测试选择器</title>
    <style type="text/css">
        * {
            margin:0;
            padding:0;
        }
        body {
            font:12px/1.5 arail;
            margin:10px;
        }
        /**/
        a {
            text-decoration:none;
        }
        div:hover, input:hover, button:hover, a:hover {
            background:#fefefe;
            cursor:pointer;
            box-shadow:1px 1px 1px #eee;
            border:1px solid #ddd;
        }
    </style>
</head>

<body>
    <div>手气不错</div>
    <div>lalalala</div>
    <div id="box1">
        <div><span>dlfdfdfdf</span>
        </div>
        <div><span>123232332</span>
        </div>
    </div>
    <a href="#">手气不错</a>
    <ul id="box" class="list">
        <li>1</li>
        <li>2</li>
        <li>3</li>
    </ul>
    <div class="box1 box2">div box1box2</div>
    <p class="box1 box2">p box1box2</p>
    <div class="box1">
        <p class="box2 box3"><a href="#">ohahalalala</a>
        </p>
    </div>
    <ul class="box2 box3">
        <li class="box1">box lists</li>
        <li class="box1">box lists</li>
        <li class="box1">box lists</li>
    </ul>
    <div class="box2 box3">
        <div class="box1">1111</div>
        <div class="box1">2222</div>
        <div class="box1">3333</div>
    </div>
    <div><span><a href="#">111111</a></span>
    </div>
    <div><span><a href="#">222222</a></span>
    </div>
    <div><span><a href="#">333333</a></span>
    </div>
    <div><span><a href="#">444444</a></span>
    </div>
    <ul id="box2" class="list">
        <li>1</li>
        <li>2</li>
        <li>3</li>
    </ul>
</body>
<!-- <script type="text/javascript" src="../js/common/basic.js"></script> -->
<script type="text/javascript">
    (function() {
        // 伪数组转化成数组
        var makeArray = function(obj) {
            if (!obj || obj.length === 0) return [];
            // 非伪类对象，直接返回最好
            if (!obj.length) {
                return obj;
            }
            // 针对IE8以前 DOM的COM实现
            try {
                return [].slice.call(obj);
            } catch (e) {
                var i = 0,
                    j = obj.length,
                    res = [];
                for (; i < j; i++) {
                    res.push(obj[i]);
                }
                return res;
            }

        };
        // 去重
        var distinctArr = function(arr) {
            // html去重和数组去重不同，单层循环搞不定啊
            for (var i = 0; i < arr.length; i++) {
                for (var j = 0; j < arr.length; j++) {
                    if (i !== j && arr[i] === arr[j]) {
                        arr.splice(j, 1);
                    }
                }
            }
            return arr;
        };
        var getContext = function(selectorString, context) {

            var sArr = selectorString.split(/[\.#]/), //选择器拆分
                tagName, selectorTagName;

            var contextArr = [], //context筛选结果
                make = []; //makeArra结果

            // 规避掉类似p#box.box1的脑残写法
            if (/#/.test(selectorString)) {

                selectorString = selectorString.match(/#[a-zA-z\d]+/)[0].substring(1);
                return document.getElementById(selectorString);

            } else if (/./g.test(selectorString)) {

                // 获取 context数组
                if (context.length === 0) {
                    return [];
                } else if (!context.length) {
                    contextArr = makeArray(context.getElementsByClassName(sArr[1]));
                } else {

                    for (var i = 0, j = context.length; i < j; i++) {
                        make = makeArray(context[i].getElementsByClassName(sArr[1]));
                        contextArr = contextArr.concat(make);
                    }
                }
                context = contextArr;

                if (selectorString[0] !== '.') {
                    // 标签配合类别选择器

                    tagName = sArr[0];



                    // 第一层为对比的类名
                    //获取符合第一个类名的环境

                    // 循环该环境对象，获取每个对象的className属性，并做比较
                    for (var m = 0; m < context.length; m++) {
                        for (var i = 1, j = sArr.length; i < j; i++) {
                            var reg = new RegExp('(^|\\s)' + sArr[i] + '(\\s|$)');
                            if (context[m].tagName.toLowerCase() !== tagName || !reg.test(context[m].className)) {
                                context.splice(m, 1);
                                m--;
                                break;
                            }
                        }
                    }
                    return context;
                } else {
                    // 纯类别选择器
                    // 可能为一个
                    // 可能为多个
                    if (selectorString.split('.').length === 2) {
                        // 一个类别的情形
                        // 遍历context
                        // 寻找
                        return context;

                    } else {
                        // 多个类别
                        for (var m = 0; m < context.length; m++) {
                            for (var i = 1, j = sArr.length; i < j; i++) {
                                var reg = new RegExp('(^|\\s)' + sArr[i] + '(\\s|$)');
                                if (!reg.test(context[m].className)) {
                                    context.splice(m, 1);
                                    m--;
                                    break;
                                }
                            }
                        }
                        return context;
                    }
                }
            }
        };
        var $ = function(selectorString, context) {

            var selectorArr = selectorString.split(/\s/),
                selectorEnd = selectorArr[selectorArr.length - 1];

            context = context || document;

            var selectorMap = function(selector) {
                if (/^\./.test(selector)) {
                    return 'getElementsByClassName';
                } else if (/^#/.test(selector)) {
                    return 'getElementById';
                } else if (!/^[\.#]/.test(selector)) {
                    return 'getElementsByTagName';
                }
            };

            var i = 0,
                j = selectorArr.length,
                result = context;

            if (selectorEnd.indexOf('#') !== -1) {
                // id选择器
                // 避免#box.test情况的出现
                return document.getElementById(selectorEnd.match(/^#[a-zA-z0-9-_]+/)[0].substring(1));
            } else {
                // if (document.querySelectorAll) {
                //     return document.querySelectorAll(selectorString);
                // } else {

                //     // 复合选择器判断


                // }

                for (; i < j; i++) {

                    result = getContext(selectorArr[i], makeArray(result));
                }
                return distinctArr(result);
            }
        };
        // 只是支持 id,class,tag选择器
        // 并且不支持复合选择器，比如#list.box, p.box, .box1.box2.box3
        // 支持复合选择器。p.box.box1,.box1.box2.box3
        // 对于标签类别配合的选择器，先从类别中进行筛选，然后比对标签
        // 可以支持：#list li,.box1 li,p a span 这样独立的选择器

        window.$ = $;
    })();
</script>
<script type="text/javascript">
    // document.addEventListener('DOMContentLoaded', function() {

    // }, false);
    window.onload = function() {
        var txt = $('.box2.box3 li.box1');
        console.log(txt);
        // alert(txt.innerHTML);
        // alert(txt[0].innerText);
    };
</script>

</html>
